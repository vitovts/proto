

URL
- https://serveradmin.ru/nastroyka-samba-s-integratsiey-v-ad/

```bash
cat /etc/redhat-release
```
```input
CentOS Linux release 7.8.2003 (Core)
```
```bash
vim /etc/sysconfig/selinux
SELINUX=disabled
```
OR
```bash
setenforce 0
```

FirewallD
```bash
systemctl stop firewalld
systemctl disable firewalld
```

#Time
```bash
yum install chrony
```
```bash
vim /etc/chrony.conf 
server dc1.xxx.local iburst

systemctl start chronyd && systemctl enable chronyd
```

install
```bash
yum install realmd sssd sssd-libwbclient oddjob oddjob-mkhomedir adcli samba-common samba-common-tools
```
Проверка
```bash
realm discover XXX.LOCAL
```
```output
xxx.local
  type: kerberos
  realm-name: XXX.LOCAL
  domain-name: xxx.local
  configured: no
  server-software: active-directory
  client-software: sssd
  required-package: oddjob
  required-package: oddjob-mkhomedir
  required-package: sssd
  required-package: adcli
  required-package: samba-common-tools
```

Завести в домен сервер
```bash
realm join -U adminXX XXX.LOCAL
```

Проверьте на самом сервере, что он нормально обращается к домену и получает информацию об учетных записях
```bash
id adminXX@xxx.local
```
```output
uid=1353801000(adminXX@xxx.local) gid=1353800513(domain users@cktema.lan) группы=1353800513(domain users@cktema.lan)
```

```bash
 realm list
```
```output
xxx.local
  type: kerberos
  realm-name: XXX.LOCAL
  domain-name: xxx.local
  configured: kerberos-member
  server-software: active-directory
  client-software: sssd
  required-package: oddjob
  required-package: oddjob-mkhomedir
  required-package: sssd
  required-package: adcli
  required-package: samba-common-tools
  login-formats: %U@xxx.local
  login-policy: allow-realm-logins
[root@srv4new1 ~]#
[root@srv4new1 ~]# adcli info xxx.local
[domain]
domain-name = xxx.local
domain-short = XXX
domain-forest = xxx.local
domain-controller = dc1.xxx.local
domain-controller-site = Default-First-Site-Name
domain-controller-flags = pdc gc ldap ds kdc timeserv closest writable good-timeserv full-secret ads-web
domain-controller-usable = yes
domain-controllers = dc1.xxx.local
[computer]
computer-site = Default-First-Site-Name
```

```bash
adcli info cktema.lan
```
```output
[domain]
domain-name = xxx.local
domain-short = XXX
domain-forest = xxx.local
domain-controller = dc1.xxx.local
domain-controller-site = Default-First-Site-Name
domain-controller-flags = pdc gc ldap ds kdc timeserv closest writable good-timeserv full-secret ads-web
domain-controller-usable = yes
domain-controllers = dc1.xxx.local
[computer]
computer-site = Default-First-Site-Name
```


#SAMBA
```bash
yum install samba
```
```bash
vim /etc/samba/smb.conf

# See smb.conf.example for a more detailed config file or
# read the smb.conf manpage.
# Run 'testparm' to verify the config is correct after
# you modified it.

[global]
#--authconfig--start-line--

# Generated by authconfig on 2020/08/14 10:17:48
# DO NOT EDIT THIS SECTION (delimited by --start-line--/--end-line--)
# Any modification may be deleted or altered by authconfig in future

        #charset
        dos charset = cp866
        unix charset = utf-8
#       display charset = utf-8

        workgroup = CKTEMA
#       password server = cktema.lan
        realm = CKTEMA.LAN
        security = ads

        interfaces = lo tap29 172.16.29.2/24 10.0.1.0/24 10.0.1.4/24


#       idmap config * : rangesize = 1000000
        idmap config * : range = 1000000-19999999
#       idmap config * : backend = autorid

        template homedir = /home/%U
        template shell = /bin/bash
        kerberos method = secrets only
        winbind use default domain = true
        winbind offline logon = false

#       encrypt passwords = yes
        passdb backend = tdbsam

        load printers = no
        show add printer wizard = no
        printcap name = /dev/null
        disable spoolss = yes

        domain master = no
        local master = no
        preferred master = no
        os level = 1

        cups options = raw
        #logs
        log file = /var/log/samba/log.%m
        log level =3
        max log size = 500
#       printing = cups


[TEST]
        comment = Shared folder for test
        path = /mnt/shara
#       public = no
#       guest ok = no
#       valid users = @"Domain Users@cktema.lan", @"iqsupport@cktema.lan"
        writeable = yes
        browsable = yes
        valid users = "@CKTEMA\Domain Users"
        admin users = "@CKTEMA\Администраторы домена",@"iqsupport@cktema.lan"
        create mask = 0600
        directory mask = 0700

[CKTEMA]
        comment = Documents for CKTEMA
        path = /mnt/cktema
#       public = no
#       guest ok = no
#       valid users = @"Domain Users@cktema.lan", @"iqsupport@cktema.lan"
        writeable = yes
        browsable = yes
        valid users = "@CKTEMA\Domain Users"
        admin users = "@CKTEMA\Администраторы домена",@"iqsupport@cktema.lan"
        create mask = 0644
        directory mask = 0700

#[homes]
#       comment = Home Directories
#       valid users = %S, %D%w%S
#       browseable = No
#       read only = No
#       inherit acls = Yes

#[printers]
#       comment = All Printers
#       path = /var/tmp
#       printable = Yes
#       create mask = 0600
#       browseable = No

#[print$]
#       comment = Printer Drivers
#       path = /var/lib/samba/drivers
#       write list = @printadmin root
#       force group = @printadmin
#       create mask = 0664
#       directory mask = 0775

```


```bash
systemctl start smb.service
systemctl enable smb.service
```

Вводим CentOS 7 в домен с помощью winbind

```bash
yum install samba-winbind samba-winbind-clients samba pam_krb5 krb5-workstation chrony
```

```bash
# authconfig --enablekrb5 --krb5kdc=xs-winsrv.xs.local --krb5adminserver=xs-winsrv.xs.local --krb5realm=XS-WINSRV.XS.LOCAL --enablewinbind --enablewinbindauth --smbsecurity=ads --smbrealm=XS.LOCAL --smbservers=xs-winsrv.xs.local --smbworkgroup=XS --winbindtemplatehomedir=/home/%U --winbindtemplateshell=/bin/bash --enablemkhomedir --enablewinbindusedefaultdomain --update
```
```bash
authconfig --enablekrb5 --krb5kdc=cktema.lan --krb5adminserver=cktema.lan.local --krb5realm=CKTEMA.LAN --enablewinbind --enablewinbindauth --smbsecurity=ads --smbrealm=CKTEMA.LAN --smbservers=cktema.lan --smbworkgroup=CKTEMA --winbindtemplatehomedir=/home/%U --winbindtemplateshell=/bin/bash --enablemkhomedir --enablewinbindusedefaultdomain --update[root@srv4new1 ~]#
```
```bash
net ads join -U iqsupport
```
```output
Enter iqsupport's password:
Using short domain name -- CKTEMA
Joined 'SRV4NEW1' to dns domain 'cktema.lan'
No DNS domain configured for srv4new1. Unable to perform DNS Update.
DNS update failed: NT_STATUS_INVALID_PARAMETER
```
























